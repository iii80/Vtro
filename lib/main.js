/**
 * 
 *   This file is part of Vtro.
 *   Copyright (C) 2020  wk989898
 *   
 *   Vtro is free software: you can redistribute it and/or modify
 *   it under the terms of the GNU General Public License as published by
 *   the Free Software Foundation, either version 3 of the License, or
 *   (at your option) any later version.
 *   
 *   This program is distributed in the hope that it will be useful,
 *   but WITHOUT ANY WARRANTY; without even the implied warranty of
 *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *   GNU General Public License for more details.
 *   
 *   You should have received a copy of the GNU General Public License
 *   along with this program.  If not, see <https://www.gnu.org/licenses/>.
 *   
 */

"use strict";const{app:e,BrowserWindow:n,ipcMain:o,Menu:t,Tray:r,shell:l}=require("electron"),s=require("path"),a=require("fs"),c=require("child_process"),d=require("http"),g=require("process"),p=require("dns");var u,f,y,b;const h=d.createServer(),w={B:1,KB:1024,MB:1<<20,GB:1<<30},m=Object.keys(w);function S(){(u=new n({width:800,height:600,webPreferences:{nodeIntegration:!0,devTools:!0}})).loadFile("index.html"),u.on("close",e=>{e.preventDefault(),u.hide()})}function x(e){return Object.prototype.toString.call(e).slice(8).replace("]","").toLowerCase()}function j(n){let o=e.isPackaged?s.resolve(e.getPath("exe"),"../"):"";return s.resolve(o,n)}function k(e,n){e&&(null==n&&(n=j("./trojan/log.txt")),a.appendFile(n,function(e="-",n=" ",o=":"){const t=new Date,[i,r,l,s,a,c]=[t.getFullYear().toString(),t.getMonth().toString().padStart(2,0),t.getDay().toString().padStart(2,0),t.getHours().toString().padStart(2,0),t.getMinutes().toString().padStart(2,0),t.getSeconds().toString().padStart(2,0)];return`[${[i,r,l].join(e)}${n}${[s,a,c].join(o)}] `}()+e+"\n","utf-8",()=>{}))}function v(e,n,o){c.execFile("./sysproxy.exe",[e,n,o],{cwd:j("./proxy"),windowsHide:!0},(e,n,o)=>{e&&k(e)&&h.close(),o&&k(o)})}function F(){b=c.execFile("./privoxy.exe",{cwd:j("./proxy"),windowsHide:!0},e=>{e&&k("privoxy error!has you close privoxy?\nplease check http://localhost:1081\n")&&h.close()}),b.pid}function q(){y&&y.kill(),b&&b.kill(),h.listening&&h.close()}async function N(e,n,o){return n?(await O("a",null,t=>{o&&o(t),"array"===x(n)?t[e].unshift(...n):t[e].unshift(n)}),Promise.resolve(!0)):(k("there is no data to be added"),Promise.resolve(!1))}function M(e,n){O("a",null,o=>{"array"===x(o[e])&&(o[e]=o[e].filter(e=>n(e)))})}async function O(e,n="",o){let t=j("./trojan/conf.json");return"r"===e?await a.readFile(t,"utf-8",(e,n)=>{e&&k(e),n=JSON.parse(n.toString()),o(n)}):"w"===e?await a.writeFile(t,JSON.stringify(n),e=>{e&&k(e)}):"a"===e?await a.readFile(t,"utf-8",(e,n)=>{e&&k(e),n=JSON.parse(n.toString()),o(n),a.writeFileSync(t,JSON.stringify(n))}):void 0}function P(e=0){e=Math.abs(e);for(let n of m)if(e<1024*w[n])return(e/w[n]).toFixed(2)+n;return(e/w.GB).toFixed(2)+i}e.name="Vtro",e.requestSingleInstanceLock()?(e.on("second-instance",(e,n,o)=>{u&&(u.isMinimized()&&u.restore(),u.focus(),u.show())}),e.on("ready",()=>{S();const n=e.isPackaged;!n&&u.webContents.openDevTools(),f=new r(n?s.resolve(e.getAppPath(),"../tray.ico"):"tray.ico");let o=[{label:"退出",click(){e.exit()}}];const i=t.buildFromTemplate(o);f.setToolTip("Vtro"),f.setContextMenu(i),f.on("click",()=>{!u.isVisible()&&u.show()})})):e.quit(),e.on("before-quit",()=>{q()}),e.on("window-all-closed",(function(n){"darwin"!==g.platform&&e.quit()})),e.on("activate",(function(){0===n.getAllWindows().length&&S()})),h.on("request",(e,n)=>{"/pac"===e.url&&(n.setHeader("Content-Type","application/x-ns-proxy-autoconfig"),a.readFile(j("./proxy/proxy.pac"),(e,o)=>{e&&n.end("error"),n.end(o)}))}),o.on("link",(e,n)=>{let o;q(),a.readFile(j("./trojan/config.json"),"utf-8",(e,n)=>{e&&k(e);let o=JSON.parse(n.toString());O("r",null,async e=>{let n;n=e.config.night&&"night"===e.config.mode?e.config.night:e.config.day,o.remote_addr=n.addr,o.remote_port=n.port,o.password[0]=n.password,o.local_port=e.config.listen[0]||1080,await a.writeFile(j("./trojan/config.json"),JSON.stringify(o),"utf-8",e=>{e&&k(e)})})}),function(e=e){let n=0,o=0;e.stderr.on("data",e=>{e.replace(/(\d*) bytes received, (\d*) bytes sent/,(e,t,i)=>{t&&i&&(n+=Number(t),o+=Number(i))})}).on("close",()=>{console.log("close",P(n),P(o))})}(y=c.execFile("trojan.exe",{cwd:j("./trojan"),windowsHide:!0},(e,n,o)=>{o&&k(o,j("./trojan/trojan-log.txt"))})),y.pid,O("r",null,e=>{const n=e.config.proxy||"pac",[t,i=1081,r=1082]=e.config.listen;if("global"===n){o=`http://127.0.0.1:${i}`,v(n,o,"localhost;127.*"),F()}else"pac"===n?(o=`http://127.0.0.1:${r}/pac`,!h.listening&&h.listen(r,"127.0.0.1",()=>{v(n,o),F()})):v("set",1)}),e.reply("linked"),console.log("link is open")}).on("close",(e,n)=>{q(),e.reply("closed"),console.log("link is closed")}),o.on("get-nodes",e=>{O("r",null,n=>{if(!n.nodes)return k("please check your conf.json");e.reply("update-nodes",n.nodes)})}).on("change-linkNode",(e,n)=>{n&&O("a",null,o=>{o.config.day=n,e.reply("config",o.config)})}).on("change-nightNode",(e,n)=>{n&&O("a",null,o=>{o.config.night=n,e.reply("config",o.config)})}).on("change-mode",(e,n)=>{O("a",null,o=>{o.config.mode=n,e.reply("mode")})}),o.on("get-sub",e=>{O("r",null,n=>{e.reply("subs",n.sub||[])})}).on("update",(e,n)=>{N("nodes",n.nodes,e=>{e.nodes.length=0}).finally(e=>{setTimeout(()=>{N("sub",n.sub,e=>{e.sub.length=0})},1e3)})}).on("remove-sub",(e,n)=>{M("sub",e=>e!==n),e.reply("removed")}),o.on("add-node",(e,n)=>{n.ip?N("nodes",n):p.resolve4(n.addr,(e,o)=>{e&&(n.ip="0"),"array"===x(o)&&(o=o[0]),n.ip=o,N("nodes",n)})}).on("delete-node",(e,n)=>{M("nodes",e=>e.ip?e.ip!==n:e.addr!=e.addr),e.reply("deleted")}).on("update-node",(e,n)=>{O("a",null,e=>{e.nodes=n})}),o.on("getConf",e=>{O("r",null,n=>{e.reply("config",n.config)})}).on("setConf",(e,n)=>{O("a",null,o=>{Object.assign(o.config,n),e.reply("config",o.config)})}),o.on("set-login",(n,o)=>{e.isPackaged?e.setLoginItemSettings({openAsHidden:!0,openAtLogin:o}):e.setLoginItemSettings({openAtLogin:o,openAsHidden:!0})}).on("get-login",n=>{n.reply("login",e.getLoginItemSettings().openAtLogin)});var T=[{type:"submenu",id:"list",label:"设置节点",submenu:[{id:"sub",label:"订阅"},{id:"add",label:"添加节点"},{id:"ping",label:"ping"},{id:"tcp-ping",label:"tcp-ping"}]},{id:"set",label:"设置",click(){L("set")}},{id:"log",label:"日志",submenu:[{id:"trojan-log",label:"trojan日志",click:()=>{l.openItem(j("trojan/trojan-log.txt"))}},{id:"linklog",label:"连接日志",click(){l.openItem(j("trojan/log.txt"))}}]}];e.isPackaged||T.push({id:"refresh",label:"refresh",role:"forceReload"});const A=t.buildFromTemplate(T);function L(e,n){return u.webContents.send(e,n)}t.setApplicationMenu(A),A.items[0].submenu.items.forEach(e=>{e.click=()=>{L(e.id)}});
//# sourceMappingURL=main.js.map
