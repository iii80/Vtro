/**
 *  Vtro
 *   a trojan client for windows
 *   by wk989898
 *   repository:https://github.com/wk989898/Vtro
 */

"use strict";const{app:e,BrowserWindow:n,ipcMain:o,Menu:t,Tray:i,shell:l}=require("electron"),r=require("path"),s=require("fs"),a=require("child_process"),c=require("http"),d=require("process");var u,p,g,f;const y=c.createServer(),h=r.resolve(d.resourcesPath);function b(){(u=new n({width:800,height:600,webPreferences:{nodeIntegration:!0,devTools:!0}})).loadFile("index.html"),u.on("close",e=>{e.preventDefault(),u.hide()})}function w(e){return Object.prototype.toString.call(e).slice(8).replace("]","").toLowerCase()}function x(e,n){null==n&&(n="./trojan/log.txt"),s.appendFile(n,e+"\n","utf-8",()=>{})}function m(e,n,o){a.execFile("./sysproxy.exe",[e,n,o],{cwd:"./proxy",windowsHide:!0},(e,n,o)=>{e&&x(e)&&y.close(),o&&x(o)})}function j(){f=a.execFile("./privoxy.exe",{cwd:"./proxy",windowsHide:!0},e=>{e&&x("privoxy error!has you close privoxy?\nplease check http://localhost:1081")&&y.close()}),f.pid}function k(){g&&g.kill(),f&&f.kill(),y.listening&&y.close()}async function v(e,n,o){if(!n)return x("there is no chunk");await S("a",null,t=>{if(o&&o(t),"array"===w(n))return t[e].unshift(...n);t[e].unshift(n)})}function F(e,n){S("a",null,o=>{"array"===w(o[e])&&(o[e]=o[e].filter(e=>n(e)))})}function S(e,n="",o){let t="trojan/conf.json";return"r"===e?s.readFile(t,"utf-8",(e,n)=>{e&&x(e),n=JSON.parse(n.toString()),o(n)}):"w"===e?s.writeFile(t,JSON.stringify(n),e=>{e&&x(e)}):"a"===e?s.readFile(t,"utf-8",async(e,i)=>{e&&x(e),n=JSON.parse(i.toString()),await o(n),s.writeFile(t,JSON.stringify(n),e=>{e&&x(e)})}):void 0}e.name="Vtro",e.on("ready",()=>{b();const n=e.isPackaged;!n&&u.webContents.openDevTools(),p=new i(n?r.resolve(h,"tray.ico"):"tray.ico");let o=[{label:"退出",click(){e.exit()}}];const l=t.buildFromTemplate(o);p.setToolTip("Vtro"),p.setContextMenu(l),p.on("click",()=>{!u.isVisible()&&u.show()})}),e.on("before-quit",()=>{k()}),e.on("window-all-closed",(function(n){"darwin"!==d.platform&&e.quit()})),e.on("activate",(function(){0===n.getAllWindows().length&&b()})),y.on("request",(e,n)=>{"/pac"===e.url&&(n.setHeader("Content-Type","application/x-ns-proxy-autoconfig"),s.readFile("./proxy/proxy.pac",(e,o)=>{e&&n.end("error"),n.end(o)}))}),o.on("get-nodes",e=>{S("r",null,n=>{if(!n.nodes)return x("please check your conf.json");e.reply("update-nodes",n.nodes)})}),o.on("link",(e,n)=>{let o;if(k(),s.readFile("./trojan/config.json","utf-8",(e,n)=>{e&&x(e);let o,t=JSON.parse(n.toString());S("r",null,e=>{const n=e.config.mode;o="night"===n?e.config.night:e.config.day}),t.remote_addr=o.addr,t.remote_port=o.port,t.password[0]=o.password,s.writeFile("./trojan/config.json",JSON.stringify(t),"utf-8",e=>{e&&x(e)})}),g=a.execFile("trojan.exe",{cwd:"./trojan",windowsHide:!0},(n,o,t)=>(n&&x(t,"./trojan/trojan-log.txt"),o&&x(o,"./trojan/trojan-log.txt"),e.reply("closed",{err:n||null}),console.log("link is closed"))),g.pid,n||S("r",null,e=>{n=e.config.proxy||"pac"}),"global"===n){o="http://127.0.0.1:1081",m(n,o,"localhost;127.*"),j()}else"pac"===n?(o="http://127.0.0.1:1082/pac",!y.listening&&y.listen(1082,"127.0.0.1",()=>{m(n,o),j()})):m("set",1);e.reply("linked")}).on("close",(e,n)=>{k()}),o.on("change-linkNode",(e,n)=>{n&&S("a",null,e=>{e.config.day=n})}).on("change-nightNode",(e,n)=>{n&&S("a",null,e=>{e.config.night=n})}),o.on("get-sub",e=>{S("r",null,n=>{e.reply("subs",n.sub||[])})}).on("update",(e,n)=>{v("nodes",n.nodes,e=>{e.nodes=[]}),v("sub",n.sub)}).on("remove-sub",(e,n)=>{F("sub",e=>e!==n),e.reply("removed")}),o.on("add-node",(e,n)=>{v("nodes",n.data)}).on("delete-node",(e,n)=>{F("nodes",e=>e.ip!==n),e.reply("deleted")}),o.on("getConf",e=>{S("r",null,n=>{e.reply("config",n.config)})}).on("setConf",(e,n)=>{S("a",null,e=>{Object.assign(e.config,n)})}),o.on("set-login",(n,o)=>{e.isPackaged?e.setLoginItemSettings({openAtLogin:o}):e.setLoginItemSettings({openAtLogin:o,path:d.execPath})}).on("get-login",n=>{n.reply("login",e.getLoginItemSettings().openAtLogin)});var q=[{type:"submenu",id:"list",label:"设置节点",submenu:[{id:"sub",label:"订阅"},{id:"add",label:"添加节点"},{id:"nodes",label:"节点列表"},{id:"ping",label:"ping"},{id:"tcp-ping",label:"tcp-ping"}]},{id:"set",label:"设置",click(){O("set")}},{id:"log",label:"日志",submenu:[{id:"trojan-log",label:"trojan日志",click:()=>{l.openItem(r.resolve("trojan/trojan-log.txt"))}},{id:"linklog",label:"连接日志",click(){l.openItem(r.resolve("trojan/log.txt"))}}]}];e.isPackaged||q.push({id:"refresh",label:"refresh",role:"forceReload"});const N=t.buildFromTemplate(q);function O(e,n){return u.webContents.send(e,n)}t.setApplicationMenu(N),N.items[0].submenu.items.forEach(e=>{e.click=()=>{O(e.id)}});
//# sourceMappingURL=main.js.map
