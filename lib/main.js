"use strict";const{app:e,BrowserWindow:t,ipcMain:o,Menu:n,Tray:i,shell:r}=require("electron"),l=require("path"),s=require("fs"),a=require("child_process"),c=require("http"),d=require("process");require("util");var p,u,f,g;const j=c.createServer(),w=l.resolve(d.resourcesPath);function h(){(p=new t({width:800,height:600,webPreferences:{nodeIntegration:!0,devTools:!0}})).loadFile("index.html"),p.on("close",e=>{e.preventDefault(),p.hide()})}function y(e,t){null==t&&(t="./trojan/log.txt"),s.appendFile(t,e+"\n","utf-8",()=>{})}function b(e,t,o){a.execFile("./sysproxy.exe",[e,t,o],{cwd:"./proxy",windowsHide:!0},(e,t,o)=>{e&&y(e)&&j.close(),o&&y(o)})}function x(){g=a.execFile("./privoxy.exe",{cwd:"./proxy",windowsHide:!0},e=>{e&&y("privoxy error!has you close privoxy?\nplease check http://localhost:1081")&&j.close()}),g.pid}function m(){f&&f.kill(),g&&g.kill(),j.listening&&j.close()}function k(e,t,o){s.readFile(e,"utf-8",(n,i)=>{let r;if(n&&y(n),i||(r=[]),r=JSON.parse(i.toString())||[],o)o(r);else if(t)try{r.unshift(t)}catch{r=[],r.unshift(t)}else y("no chunk or callback paramater in addfile func");s.writeFile(e,JSON.stringify(r),e=>{e&&y(e)})})}function F(e,t,o){s.readFile(e,"utf-8",(t,n)=>{if(t&&y(t),!n)return;let i=JSON.parse(n.toString());i=i.filter(e=>o(e)),s.writeFile(e,JSON.stringify(i),"utf-8",e=>{e&&y(e)})})}e.name="Vtro",e.on("ready",()=>{h();const t=e.isPackaged;!t&&p.webContents.openDevTools(),u=new i(t?l.resolve(w,"tray.ico"):"tray.ico");let o=[{label:"退出",click(){e.exit()}}];const r=n.buildFromTemplate(o);u.setToolTip("Vtro"),u.setContextMenu(r),u.on("click",()=>{!p.isVisible()&&p.show()})}),e.on("before-quit",()=>{m()}),e.on("window-all-closed",(function(t){"darwin"!==d.platform&&e.quit()})),e.on("activate",(function(){0===t.getAllWindows().length&&h()})),j.on("request",(e,t)=>{"/pac"===e.url&&(t.setHeader("Content-Type","application/x-ns-proxy-autoconfig"),s.readFile("./proxy/proxy.pac",(e,o)=>{e&&t.end("error"),t.end(o)}))}),o.once("getnow",(e,t)=>{s.readFile("./trojan/now.json","utf-8",(t,o)=>{if(t&&y(t),!o)return e.reply("setnow","");let n=JSON.parse(o).name;e.reply("setnow",n||"")})}),o.on("link",(e,t)=>{m(),f=a.execFile("trojan.exe",{cwd:"./trojan",windowsHide:!0},(t,o,n)=>(t&&y(n,"./trojan/trojanlog.txt"),n&&y(n,"./trojan/trojanlog.txt"),e.reply("closed",{err:t||(n||null)}),console.log("link is closed"))),f.pid;let o="";if("global"===t){o="http://127.0.0.1:1081",b(t,o,"localhost;127.*"),x()}else"pac"===t?(o="http://127.0.0.1:1082/pac",!j.listening&&j.listen(1082,"127.0.0.1",()=>{b(t,o),x()})):b("set",1);e.reply("linked")}),o.on("close",(e,t)=>{m()}),o.on("change-linklist",(e,t)=>{t&&s.readFile("./trojan/config.json","utf-8",(e,o)=>{e&&y(e),s.writeFile("./trojan/now.json",JSON.stringify(t),"utf-8",e=>{e&&y(e)});let n=JSON.parse(o.toString());n.remote_addr=t.addr,n.remote_port=t.port,n.password[0]=t.password,s.writeFile("./trojan/config.json",JSON.stringify(n),"utf-8",e=>{e&&y(e)})})}),o.on("get-sub",e=>{s.readFile("./trojan/sub.json",(t,o)=>{if(t)return y(t);let n=JSON.parse(o.toString())||[];o&&e.reply("sub",n)})}),o.on("update",(e,t)=>{k("./trojan/sub.json",t.sub),k("./trojan/lists.json",t.data)}),o.on("get-lists",(e,t)=>{s.readFile("./trojan/lists.json","utf-8",(t,o)=>{if(t&&s.writeFile("./trojan/lists.json",JSON.stringify([]),()=>{}),!o)return y("please check your lists.json");let n=JSON.parse(o.toString());e.reply("update-lists",n)})}),o.on("add-list",(e,t)=>{k("./trojan/lists.json",t.data)}),o.on("delete-list",(e,t)=>{F("./trojan/lists.json",0,e=>e.ip!==t),e.reply("deleted")}),o.on("remove-sub",(e,t)=>{F("./trojan/sub.json",0,e=>e!==t),e.reply("removed")});var S=[{id:"list",label:"设置节点",submenu:[{id:"sub",label:"订阅"},{id:"add",label:"添加节点"},{id:"lists",label:"节点列表"},{id:"ping",label:"ping"},{id:"tcp-ping",label:"tcp-ping"}]},{id:"set",label:"设置"},{id:"log",label:"日志",submenu:[{id:"trojanlog",label:"trojan日志",click:()=>{try{r.openItem(l.resolve("trojan/trojanlog.txt"))}catch(e){}}},{id:"linklog",label:"连接日志",click(){try{r.openItem(l.resolve("trojan/log.txt"))}catch(e){}}}]}];e.isPackaged||S.push({id:"refresh",label:"refresh",role:"forceReload"});const v=n.buildFromTemplate(S);function J(e,t){return p.webContents.send(e,t)}n.setApplicationMenu(v),v.items.forEach(e=>{let t=e.submenu;"log"!==e.id&&"refresh"!==e.id&&(t?t.items.forEach(e=>{e.click=()=>{J(e.id)}}):e.click=()=>{J(e.id)})});
//# sourceMappingURL=main.js.map
