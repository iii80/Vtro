"use strict";const{app:e,BrowserWindow:t,ipcMain:o,Menu:n,Tray:i,shell:r}=require("electron"),l=require("path"),s=require("fs"),a=require("child_process"),c=require("http"),p=require("process"),d=require("ping"),u=require("util"),f=require("tcp-ping"),g=u.promisify(f.ping);var h,j,w,y,b=[];const m=c.createServer(),x=l.resolve(p.resourcesPath);function k(){(h=new t({width:800,height:600,webPreferences:{nodeIntegration:!0,devTools:!0}})).loadFile("index.html"),h.on("close",e=>{e.preventDefault(),h.hide()})}function F(e,t){null==t&&(t="./trojan/log.txt"),s.appendFile(t,e+"\n","utf-8",()=>{})}function v(e,t,o){a.execFile("./sysproxy.exe",[e,t,o],{cwd:"./proxy",windowsHide:!0},(e,t,o)=>{e&&F(e)&&m.close(),o&&F(o)})}function S(){y=a.execFile("./privoxy.exe",{cwd:"./proxy",windowsHide:!0},e=>{e&&F("privoxy error!has you close privoxy?\nplease check http://localhost:1081")&&m.close()}),y.pid}function q(){w&&w.kill(),y&&y.kill(),m.listening&&m.close()}function J(e,t,o){s.readFile(e,"utf-8",(n,i)=>{let r;if(n&&F(n),i||(r=[]),r=JSON.parse(i.toString())||[],o)o(r);else if(t)try{r.unshift(t)}catch{r=[],r.unshift(t)}else F("no chunk or callback paramater in addfile func");s.writeFile(e,JSON.stringify(r),e=>{e&&F(e)})})}function N(e,t,o){s.readFile(e,"utf-8",(t,n)=>{if(t&&F(t),!n)return;let i=JSON.parse(n.toString());i=i.filter(e=>o(e)),s.writeFile(e,JSON.stringify(i),"utf-8",e=>{e&&F(e)})})}async function O(e,t,o){0!==b.length&&(b=[]);const n=Date.now();await Promise.all(t.map(e=>o(e))).then(e=>{e.forEach(e=>{let t=parseInt(e.min)||-1;b.push(t)})}).catch(e=>F(e)),console.log(`ping cost:${Date.now()-n}ms\nnum:${b.length}`),e.reply("ping-result",b),J("./trojan/lists.json",null,e=>{for(let t in e)e[t].ping=b[t]})}e.name="Vtro",e.on("ready",()=>{k();const t=e.isPackaged;!t&&h.webContents.openDevTools(),j=new i(t?l.resolve(x,"tray.ico"):"tray.ico");let o=[{label:"退出",click(){e.exit()}}];const r=n.buildFromTemplate(o);j.setToolTip("Vtro"),j.setContextMenu(r),j.on("click",()=>{!h.isVisible()&&h.show()})}),e.on("before-quit",()=>{q()}),e.on("window-all-closed",(function(t){"darwin"!==p.platform&&e.quit()})),e.on("activate",(function(){0===t.getAllWindows().length&&k()})),m.on("request",(e,t)=>{"/pac"===e.url&&(t.setHeader("Content-Type","application/x-ns-proxy-autoconfig"),s.readFile("./proxy/proxy.pac",(e,o)=>{e&&t.end("error"),t.end(o)}))}),o.once("getnow",(e,t)=>{s.readFile("./trojan/now.json","utf-8",(t,o)=>{if(t&&F(t),!o)return e.reply("setnow","");let n=JSON.parse(o).name;e.reply("setnow",n||"")})}),o.on("link",(e,t)=>{q(),w=a.execFile("trojan.exe",{cwd:"./trojan",windowsHide:!0},(t,o,n)=>(t&&F(n,"./trojan/trojanlog.txt"),n&&F(n,"./trojan/trojanlog.txt"),e.reply("closed",{err:t||(n||null)}),console.log("link is closed"))),w.pid;let o="";if("global"===t){o="http://127.0.0.1:1081",v(t,o,"localhost;127.*"),S()}else"pac"===t?(o="http://127.0.0.1:1082/pac",!m.listening&&m.listen(1082,"127.0.0.1",()=>{v(t,o),S()})):v("set",1);e.reply("linked")}),o.on("close",(e,t)=>{q()}),o.on("change-linklist",(e,t)=>{t&&s.readFile("./trojan/config.json","utf-8",(e,o)=>{e&&F(e),s.writeFile("./trojan/now.json",JSON.stringify(t),"utf-8",e=>{e&&F(e)});let n=JSON.parse(o.toString());n.remote_addr=t.addr,n.remote_port=t.port,n.password[0]=t.password,s.writeFile("./trojan/config.json",JSON.stringify(n),"utf-8",e=>{e&&F(e)})})}),o.on("get-sub",e=>{s.readFile("./trojan/sub.json",(t,o)=>{if(t)return F(t);let n=JSON.parse(o.toString())||[];o&&e.reply("sub",n)})}),o.on("update",(e,t)=>{J("./trojan/sub.json",t.sub),J("./trojan/lists.json",t.data)}),o.on("get-lists",(e,t)=>{s.readFile("./trojan/lists.json","utf-8",(t,o)=>{if(t){let e=[];s.writeFile("./trojan/lists.json",JSON.stringify(e),()=>{})}if(!o){return void F("please check your lists.json")}let n=JSON.parse(o.toString());e.reply("update-lists",n)})}),o.on("add-list",(e,t)=>{J("./trojan/lists.json",t.data)}),o.on("delete-list",(e,t)=>{N("./trojan/lists.json",0,e=>e.ip!==t),e.reply("deleted")}),o.on("remove-sub",(e,t)=>{N("./trojan/sub.json",0,e=>e!==t),e.reply("removed")}),o.on("tcping",(e,t)=>{O(e,t,e=>g({address:e.ip||e.addr,port:e.port||443,attempts:3}))}),o.on("all-ping",async(e,t)=>{O(e,t,e=>d.promise.probe(e.addr,{timeout:10}))});var T=[{id:"list",label:"设置节点",submenu:[{id:"sub",label:"订阅"},{id:"add",label:"添加节点"},{id:"lists",label:"节点列表"},{id:"ping",label:"ping"},{id:"tcp-ping",label:"tcp-ping"}]},{id:"set",label:"设置"},{id:"log",label:"日志",submenu:[{id:"trojanlog",label:"trojan日志",click:()=>{try{r.openItem(l.resolve("trojan/trojanlog.txt"))}catch(e){}}},{id:"linklog",label:"连接日志",click(){try{r.openItem(l.resolve("trojan/log.txt"))}catch(e){}}}]}];e.isPackaged||T.push({id:"refresh",label:"refresh",role:"forceReload"});const P=n.buildFromTemplate(T);function C(e,t){return h.webContents.send(e,t)}n.setApplicationMenu(P),P.items.forEach(e=>{let t=e.submenu;"log"!==e.id&&"refresh"!==e.id&&(t?t.items.forEach(e=>{e.click=()=>{C(e.id)}}):e.click=()=>{C(e.id)})});
//# sourceMappingURL=main.js.map
