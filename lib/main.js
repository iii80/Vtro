/**
 *  Vtro
 *   a trojan client for windows
 *   by wk989898
 *   repository:https://github.com/wk989898/Vtro
 */

"use strict";const{app:e,BrowserWindow:o,ipcMain:n,Menu:t,Tray:r,shell:l}=require("electron"),i=require("path"),s=require("fs"),a=require("child_process"),c=require("http"),d=require("process");require("util");var u,p,f,g;const w=c.createServer(),y=i.resolve(d.resourcesPath);function h(){(u=new o({width:800,height:600,webPreferences:{nodeIntegration:!0,devTools:!0}})).loadFile("index.html"),u.on("close",e=>{e.preventDefault(),u.hide()})}function b(e){return Object.prototype.toString.call(e).slice(8).replace("]","").toLowerCase()}function x(e,o){null==o&&(o="./trojan/log.txt"),s.appendFile(o,e+"\n","utf-8",()=>{})}function j(e,o,n){a.execFile("./sysproxy.exe",[e,o,n],{cwd:"./proxy",windowsHide:!0},(e,o,n)=>{e&&x(e)&&w.close(),n&&x(n)})}function m(){g=a.execFile("./privoxy.exe",{cwd:"./proxy",windowsHide:!0},e=>{e&&x("privoxy error!has you close privoxy?\nplease check http://localhost:1081")&&w.close()}),g.pid}function k(){f&&f.kill(),g&&g.kill(),w.listening&&w.close()}async function v(e,o,n){if(!o)return x("there is no chunk");await S("a",null,t=>{if(n&&n(t),"array"===b(o))return t[e].unshift(...o);t[e].unshift(o)})}function F(e,o){S("a",null,n=>{"array"===b(n[e])&&(n[e]=n[e].filter(e=>o(e)))})}function S(e,o="",n){let t="trojan/conf.json";return"r"===e?s.readFile(t,"utf-8",(e,o)=>{e&&x(e),o=JSON.parse(o.toString()),n(o)}):"w"===e?s.writeFile(t,JSON.stringify(o),e=>{e&&x(e)}):"a"===e?s.readFile(t,"utf-8",async(e,r)=>{e&&x(e),o=JSON.parse(r.toString()),await n(o),s.writeFile(t,JSON.stringify(o),e=>{e&&x(e)})}):void 0}e.name="Vtro",e.on("ready",()=>{h();const o=e.isPackaged;!o&&u.webContents.openDevTools(),p=new r(o?i.resolve(y,"tray.ico"):"tray.ico");let n=[{label:"退出",click(){e.exit()}}];const l=t.buildFromTemplate(n);p.setToolTip("Vtro"),p.setContextMenu(l),p.on("click",()=>{!u.isVisible()&&u.show()})}),e.on("before-quit",()=>{k()}),e.on("window-all-closed",(function(o){"darwin"!==d.platform&&e.quit()})),e.on("activate",(function(){0===o.getAllWindows().length&&h()})),w.on("request",(e,o)=>{"/pac"===e.url&&(o.setHeader("Content-Type","application/x-ns-proxy-autoconfig"),s.readFile("./proxy/proxy.pac",(e,n)=>{e&&o.end("error"),o.end(n)}))}),n.once("getnow",(e,o)=>{S("r",null,o=>{let n=o.now.name;e.reply("setnow",n||"")})}).on("get-nodes",(e,o)=>{S("r",null,o=>{if(!o.nodes)return x("please check your conf.json");e.reply("update-nodes",o.nodes)})}),n.on("link",(e,o)=>{let n;if(k(),f=a.execFile("trojan.exe",{cwd:"./trojan",windowsHide:!0},(o,n,t)=>(o&&x(t,"./trojan/trojan-log.txt"),n&&x(n,"./trojan/trojan-log.txt"),e.reply("closed",{err:o||null}),console.log("link is closed"))),f.pid,"global"===o){n="http://127.0.0.1:1081",j(o,n,"localhost;127.*"),m()}else"pac"===o?(n="http://127.0.0.1:1082/pac",!w.listening&&w.listen(1082,"127.0.0.1",()=>{j(o,n),m()})):j("set",1);e.reply("linked")}).on("close",(e,o)=>{k()}),n.on("change-linknode",(e,o)=>{o&&s.readFile("./trojan/config.json","utf-8",(e,n)=>{e&&x(e),S("a",null,e=>{e.now=o});let t=JSON.parse(n.toString());t.remote_addr=o.addr,t.remote_port=o.port,t.password[0]=o.password,s.writeFile("./trojan/config.json",JSON.stringify(t),"utf-8",e=>{e&&x(e)})})}),n.on("get-sub",e=>{S("r",null,o=>{e.reply("subs",o.sub||[])})}).on("update",(e,o)=>{v("nodes",o.nodes,e=>{e.nodes=[]}),v("sub",o.sub)}).on("remove-sub",(e,o)=>{F("sub",e=>e!==o),e.reply("removed")}),n.on("add-node",(e,o)=>{v("nodes",o.data)}).on("delete-node",(e,o)=>{F("nodes",e=>e.ip!==o),e.reply("deleted")});var q=[{id:"list",label:"设置节点",submenu:[{id:"sub",label:"订阅"},{id:"add",label:"添加节点"},{id:"nodes",label:"节点列表"},{id:"ping",label:"ping"},{id:"tcp-ping",label:"tcp-ping"}]},{id:"set",label:"设置"},{id:"log",label:"日志",submenu:[{id:"trojanlog",label:"trojan日志",click:()=>{try{l.openItem(i.resolve("trojan/trojanlog.txt"))}catch(e){}}},{id:"linklog",label:"连接日志",click(){try{l.openItem(i.resolve("trojan/log.txt"))}catch(e){}}}]}];e.isPackaged||q.push({id:"refresh",label:"refresh",role:"forceReload"});const T=t.buildFromTemplate(q);function O(e,o){return u.webContents.send(e,o)}t.setApplicationMenu(T),T.items.forEach(e=>{let o=e.submenu;"log"!==e.id&&"refresh"!==e.id&&(o?o.items.forEach(e=>{e.click=()=>{O(e.id)}}):e.click=()=>{O(e.id)})});
//# sourceMappingURL=main.js.map
