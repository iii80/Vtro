"use strict";const{app:e,BrowserWindow:t,ipcMain:o,Menu:n,Tray:i,shell:l}=require("electron"),r=require("path"),s=require("fs"),a=require("child_process"),c=require("http"),d=require("process");var p,u,f,g,j=require("ping");const w=c.createServer(),h=r.resolve(d.resourcesPath);function y(){(p=new t({width:800,height:600,webPreferences:{nodeIntegration:!0,devTools:!0}})).loadFile("index.html"),p.on("close",e=>{e.preventDefault(),p.hide()})}function b(e,t){null==t&&(t="./trojan/log.txt"),s.appendFile(t,e+"\n","utf-8",()=>{})}function m(e,t,o){a.execFile("./sysproxy.exe",[e,t,o],{cwd:"./proxy",windowsHide:!0},(e,t,o)=>{e&&b(e)&&w.close(),o&&b(o)})}function x(){g=a.execFile("./privoxy.exe",{cwd:"./proxy",windowsHide:!0},e=>{e&&b("privoxy error!has you close privoxy?\nplease check http://localhost:1081")&&w.close()}),g.pid}function k(){f&&f.kill(),g&&g.kill(),w.listening&&w.close()}function v(e,t,o){s.readFile(e,"utf-8",(n,i)=>{let l;if(n&&b(n),i||(l=[]),l=JSON.parse(i.toString())||[],o)o(l);else if(t)try{l.unshift(t)}catch{l=[],l.unshift(t)}else b("no chunk or callback paramater in addfile func");s.writeFile(e,JSON.stringify(l),e=>{e&&b(e)})})}function F(e,t,o){s.readFile(e,"utf-8",(t,n)=>{if(t&&b(t),!n)return;let i=JSON.parse(n.toString());i=i.filter(e=>o(e)),s.writeFile(e,JSON.stringify(i),"utf-8",e=>{e&&b(e)})})}e.name="Vtro",e.on("ready",()=>{y();const t=e.isPackaged;!t&&p.webContents.openDevTools(),u=new i(t?r.resolve(h,"tray.ico"):"tray.ico");let o=[{label:"退出",click(){e.exit()}}];const l=n.buildFromTemplate(o);u.setToolTip("Vtro"),u.setContextMenu(l),u.on("click",()=>{!p.isVisible()&&p.show()})}),e.on("before-quit",()=>{k()}),e.on("window-all-closed",(function(t){"darwin"!==d.platform&&e.quit()})),e.on("activate",(function(){0===t.getAllWindows().length&&y()})),w.on("request",(e,t)=>{"/pac"===e.url&&(t.setHeader("Content-Type","application/x-ns-proxy-autoconfig"),s.readFile("./proxy/proxy.pac",(e,o)=>{e&&t.end("error"),t.end(o)}))}),o.once("getnow",(e,t)=>{s.readFile("./trojan/now.json","utf-8",(t,o)=>{if(t&&b(t),!o)return e.reply("setnow","");let n=JSON.parse(o).name;e.reply("setnow",n||"")})}),o.on("link",(e,t)=>{k(),f=a.execFile("trojan.exe",{cwd:"./trojan",windowsHide:!0},(t,o,n)=>(t&&b(n,"./trojan/trojanlog.txt"),n&&b(n,"./trojan/trojanlog.txt"),e.reply("closed",{err:t||(n||null)}),console.log("link is closed"))),f.pid;let o="";if("global"===t){o="http://127.0.0.1:1081",m(t,o,"localhost;127.*"),x()}else"pac"===t?(o="http://127.0.0.1:1082/pac",!w.listening&&w.listen(1082,"127.0.0.1",()=>{m(t,o),x()})):m("set",1);e.reply("linked")}),o.on("close",(e,t)=>{k()}),o.on("change-linklist",(e,t)=>{t&&s.readFile("./trojan/config.json","utf-8",(e,o)=>{e&&b(e),s.writeFile("./trojan/now.json",JSON.stringify(t),"utf-8",e=>{e&&b(e)});let n=JSON.parse(o.toString());n.remote_addr=t.addr,n.remote_port=t.port,n.password[0]=t.password,s.writeFile("./trojan/config.json",JSON.stringify(n),"utf-8",e=>{e&&b(e)})})}),o.on("get-sub",e=>{s.readFile("./trojan/sub.json",(t,o)=>{if(t)return b(t);let n=JSON.parse(o.toString())||[];o&&e.reply("sub",n)})}),o.on("update",(e,t)=>{v("./trojan/sub.json",t.sub),v("./trojan/lists.json",t.data)}),o.on("get-lists",(e,t)=>{s.readFile("./trojan/lists.json","utf-8",(t,o)=>{if(t){let e=[];s.writeFile("./trojan/lists.json",JSON.stringify(e),()=>{})}if(!o){return void b("please check your lists.json")}let n=JSON.parse(o.toString());e.reply("update-lists",n)})}),o.on("add-list",(e,t)=>{v("./trojan/lists.json",t.data)}),o.on("delete-list",(e,t)=>{F("./trojan/lists.json",0,e=>e.ip!==t),e.reply("deleted")}),o.on("remove-sub",(e,t)=>{F("./trojan/sub.json",0,e=>e!==t),e.reply("removed")}),o.on("all-ping",async(e,t)=>{let o=[];const n=Date.now();await Promise.all(t.map(e=>j.promise.probe(e.addr,{timeout:10}))).then(e=>{e.forEach((e,t)=>{"unknown"===e.avg&&(e.avg=-1),o[t]=parseInt(e.avg)})}).catch(e=>{b(e)}),console.log(o),console.log(`ping cost:${Date.now()-n}ms\nnum:${o.length}`),e.reply("ping-result",o),v("./trojan/lists.json",null,e=>{for(let t in e)e[t].ping=o[t]})});var S=[{id:"list",label:"设置节点",submenu:[{id:"sub",label:"订阅"},{id:"add",label:"添加节点"},{id:"lists",label:"节点列表"},{id:"ping",label:"ping"}]},{id:"set",label:"设置"},{id:"log",label:"日志",submenu:[{id:"trojanlog",label:"trojan日志",click:()=>{try{l.openItem(r.resolve("trojan/trojanlog.txt"))}catch(e){}}},{id:"linklog",label:"连接日志",click(){try{l.openItem(r.resolve("trojan/log.txt"))}catch(e){}}}]}];e.isPackaged||S.push({id:"refresh",label:"refresh",role:"forceReload"});const J=n.buildFromTemplate(S);function N(e,t){return p.webContents.send(e,t)}n.setApplicationMenu(J),J.items.forEach(e=>{let t=e.submenu;"log"!==e.id&&"refresh"!==e.id&&(t?t.items.forEach(e=>{e.click=()=>{N(e.id)}}):e.click=()=>{N(e.id)})});
//# sourceMappingURL=main.js.map
